name: Mongo CRUD GDPR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  mongo-crud-check:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get changed Python files
        id: files
        run: |
          git fetch origin ${{ github.base_ref }}
          files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Mongo CRUD detector
        if: steps.files.outputs.files != ''
        run: |
          python .github/scripts/mongo_crud_detector.py \
            ${{ steps.files.outputs.files }}

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('mongo_crud_report.md')) return;
            const reportBody = fs.readFileSync('mongo_crud_report.md', 'utf8');

            // Create or update PR comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportBody
            });

            // Set PR label based on severity
            const reportText = reportBody.toLowerCase();
            const labels = [];
            if (reportText.includes('⚠️ dynamic')) {
              labels.push('mongo-dynamic')
            }
            if (reportText.includes('collection: `<dynamic>`')) {
              labels.push('mongo-dynamic-collection')
            }
            if (labels.length > 0) {
              github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels
              });
            }
      - name: Create Jira ticket for Mongo CRUD changes
        if: always()
        env:
          ATLASSIAN_BASE_URL: ${{ secrets.ATLASSIAN_BASE_URL }}
          ATLASSIAN_EMAIL: ${{ secrets.ATLASSIAN_EMAIL }}
          ATLASSIAN_API_TOKEN: ${{ secrets.ATLASSIAN_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          JIRA_ISSUE_TYPE: ${{ secrets.JIRA_ISSUE_TYPE }}
        run: |
          if [ ! -f mongo_crud_report.md ]; then
            echo "No Mongo CRUD report found. Skipping Jira creation."
            exit 0
          fi

          REPORT_BODY=$(sed 's/"/\\"/g' mongo_crud_report.md | tr '\n' '\\n')

          PAYLOAD=$(cat <<EOF
          {
            "fields": {
              "project": {
                "key": "$JIRA_PROJECT_KEY"
              },
              "summary": "[GDPR Review] MongoDB CRUD detected in PR #${{ github.event.pull_request.number }}",
              "description": {
                "type": "doc",
                "version": 1,
                "content": [
                  {
                    "type": "paragraph",
                    "content": [
                      {
                        "type": "text",
                        "text": "MongoDB CRUD operations were detected and require GDPR review."
                      }
                    ]
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {
                        "type": "text",
                        "text": "Repository: ${{ github.repository }}"
                      }
                    ]
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {
                        "type": "text",
                        "text": "Pull Request: ${{ github.event.pull_request.html_url }}"
                      }
                    ]
                  },
                  {
                    "type": "codeBlock",
                    "attrs": {
                      "language": "markdown"
                    },
                    "content": [
                      {
                        "type": "text",
                        "text": "$REPORT_BODY"
                      }
                    ]
                  }
                ]
              },
              "issuetype": {
                "name": "$JIRA_ISSUE_TYPE"
              }
            }
          }
          EOF
          )

          curl -s -X POST \
            -u "$ATLASSIAN_EMAIL:$ATLASSIAN_API_TOKEN" \
            -H "Content-Type: application/json" \
            "$ATLASSIAN_BASE_URL/rest/api/3/issue" \
            --data "$PAYLOAD"
