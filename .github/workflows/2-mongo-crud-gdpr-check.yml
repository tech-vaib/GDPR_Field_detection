name: Mongo CRUD GDPR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  mongo-crud-check:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get changed Python files
        id: files
        run: |
          git fetch origin ${{ github.base_ref }}
          files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Mongo CRUD detector
        if: steps.files.outputs.files != ''
        run: |
          python .github/scripts/mongo_crud_detector.py \
            ${{ steps.files.outputs.files }}

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('mongo_crud_report.md')) return;
            const reportBody = fs.readFileSync('mongo_crud_report.md', 'utf8');

            // Create or update PR comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportBody
            });

            // Set PR label based on severity
            const reportText = reportBody.toLowerCase();
            const labels = [];
            if (reportText.includes('⚠️ dynamic')) {
              labels.push('mongo-dynamic')
            }
            if (reportText.includes('collection: `<dynamic>`')) {
              labels.push('mongo-dynamic-collection')
            }
            if (labels.length > 0) {
              github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels
              });
            }
